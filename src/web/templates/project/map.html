{% extends 'base.html' %}

{% block header %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <h1>{% block title %}Pick Task for "{{ project['title'] }}"{% endblock %}</h1>
{% endblock %}

{% block content %}
  {% if msg %}
    <p id="quick_view">{{msg}}</p>
  {% endif %}

  <div id="map"></div>



  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>

  <!-- responseive Leaflet popups -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.css" />
  <script src="https://unpkg.com/leaflet-responsive-popup@1.0.0/leaflet.responsive.popup.js"></script>

  <script>
   // var project_id = {{project_id}};
   // var project_title = '{{project_name}}';
   // var project_outline = {{project_outline}};
   // var tasks = (tasks|default({}))|tojson;
   // var tasks = []
   // var user_id = '{{userid}}';

    function setMap() {
      const map = L.map("map");
      const osm = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }
      ).addTo(map);

      // zoom to map
      grid = addGeoJSONLayer(map)
      map.fitBounds(grid.getBounds());
    }

    function addGeoJSONLayer(map) {
      //layer = L.geoJson(project_outline);
      //layer = L.geoJSON(project_outline, {
        //onEachFeature: createPopup
      //});
      //layer.addTo(map);
      //return layer;
    }

    //READY = 0
    //LOCKED_FOR_MAPPING = 1
    //MAPPED = 2
    //LOCKED_FOR_VALIDATION = 3
    //VALIDATED = 4
    //INVALIDATED = 5
    //BAD = 6  # Task cannot be mapped 
    //SPLIT = 7  # Task has been split

    function getStyle(statusValue) {
      bg = 'rgb(216, 218, 228)' // set to unavailable
      switch(statusValue) {
        case 'READY':
          bg = 'rgb(255, 255, 255)'
          break;
        case 'LOCKED_FOR_MAPPING':
          bg = 'rgb(216, 218, 228)'
          break;
        case 'MAPPED':
          bg = 'rgb(173, 230, 239)'
          break;
        default:
          bg = 'rgb(216, 218, 228)' //set to unavailable
          break;
      }

      return {color: '#e1e0e0',
        weight: 1,
        fillOpacity:0.8,
        fillColor: bg
      }
    } 

    function createPopup(feature, layer) {
      
      if (feature.properties && feature.properties.id) {
        feature_id = feature.properties.id;
        task = tasks[feature_id];
        qrcode_src = "{{url_for('static', filename=project_path+'/QR_codes/')}}";
        final_qrcode_src = qrcode_src+"buildings_"+feature_id+".gif";

        layer.setStyle(getStyle(task.status.value))

        var popupOptions = {
          'maxWidth': '500',
          'className' : 'fmtm-popup' // classname for another popup
        }

        //var popup = L.pop()
        switch(task.status) {
          case 'READY':
            layer.bindPopup(
                `<div class='fmtm-popup-div' width: window.innerWidth; height: window.innerHeight>
                  <h1>Task ${task.name}</h1>
                  <p>${task.status}</p>
                  <p>To start field mapping, scan the QR Code using ODK Collect and click 'Assign me this task'. If you are on your mobile device, you can download the QR Code for use in ODK.</p>
                  <img src='' alt='' height='150dp' width='150dp' max-width='150dp'>

                  <form method='post'>
                    <input style=\"display:none;\" name='taskid' id='taskid'
                      value=${task.uid} required>
                    <input style=\"display:none;\" name='qrcode' id='qrcode'
                      value='yes' required>
                    <input type='submit' value='Download QR Code'>
                  </form>

                  <form method='post'>
                    <input style=\"display:none;\" name='taskid' id='taskid'
                      value=${task.uid} required>
                    <input style=\"display:none;\" name='newstatus' id='newstatus'
                      value="Unavailable" required>
                    <input style=\"display:none;\" name='qrcode' id='qrcode'
                      value='no' required>
                    <input type='submit' value='Just assign me this Task'>
                  </form>
                </div>`, popupOptions
            )
            break;
          case 'unavailable': 
            if (user_id == task.task_doer) {
              layer.bindPopup(
                `<div class='fmtm-popup-div'>
                  <h1>Task ${task.feature_id}</h1>
                  <p>Status: ${task.status}</p>
                  
                  <img src='' alt='' height='150dp' width='150dp' max-width='150dp'>

                  <form method='post'>
                    <input style=\"display:none;\" name='taskid' id='taskid'
                      value=${task.feature_id} required>
                      <input style=\"display:none;\" name='qrcode' id='qrcode'
                      value='yes' required>
                    <input type='submit' value='Download QR Code'>
                  </form>
                </div>
                `, popupOptions
              )
            } 
            break; 
          default:
            layer.bindPopup(
              `<h1>Task ${task.feature_id}</h1>
              <p>${task.status}</p>
              `, popupOptions
            )  
        }
        //  layer.bindPopup(popup, popupOptions)  
      }
    }

    //setMap()

  </script>
{% endblock %}
